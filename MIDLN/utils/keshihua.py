import math
import os
from copy import copy
from pathlib import Path
import shutil
import imageio

import cv2
import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import seaborn as sn
import torch
from PIL import Image, ImageDraw, ImageFont


# def feature_visualization(x, module_type, stage, n=32, save_dir=Path('feature_visualization')):
#     """
#     x:              Features to be visualized
#     module_type:    Module type
#     stage:          Module stage within model
#     n:              Maximum number of feature maps to plot
#     save_dir:       Directory to save results
#     """
#     if 'Detect' not in module_type:
#         batch, channels, height, width = x.shape  # batch, channels, height, width
#         if height > 1 and width > 1:
#             f = save_dir / f"stage{stage}_{module_type.split('.')[-1]}_features.png"  # filename
#
#             blocks = torch.chunk(x[0].cpu(), channels, dim=0)  # select batch index 0, block by channels
#             n = min(n, channels)  # number of plots
#             fig, ax = plt.subplots(math.ceil(n / 8), 8, tight_layout=True)  # 8 rows x n/8 cols
#             ax = ax.ravel()
#             plt.subplots_adjust(wspace=0.05, hspace=0.05)
#             for i in range(n):
#                 ax[i].imshow(blocks[i].squeeze())  # cmap='gray'
#                 ax[i].axis('off')
#
#             print(f'Saving {f}... ({n}/{channels})')
#             plt.savefig(f, dpi=300, bbox_inches='tight')
#             plt.close()
#             np.save(str(f.with_suffix('.npy')), x[0].cpu().numpy())  # npy save
def feature_visualization(x, module_type, stage, n=32, save_dir=Path('runs/detect/exp')):
    """
    x:              Features to be visualized
    module_type:    Module type
    stage:          Module stage within model
    n:              Maximum number of feature maps to plot
    save_dir:       Directory to save results
    """
    if 'Detect' not in module_type:

            batch, channels, height, width = x.shape  # batch, channels, height, width
            if height > 1 and width > 1:
                f = save_dir / f"stage{stage}_{module_type.split('.')[-1]}_features.png"  # filename

                blocks = torch.chunk(x[0].cpu(), channels, dim=0)  # select batch index 0, block by channels
                n = min(n, channels)  # number of plots
                fig, ax = plt.subplots(math.ceil(n / 4), 4, tight_layout=True)  # 8 rows x n/8 cols
                ax = ax.ravel()
                plt.subplots_adjust(wspace=0.05, hspace=0.05)
                for i in range(n):
                    block = blocks[i].squeeze().detach().numpy()
                    block = (block - np.min(block)) / (np.max(block) - np.min(block))
                    temp = np.array(block * 255.0, dtype=np.uint8)
                    temp = cv2.applyColorMap(temp, cv2.COLORMAP_JET)
                    ax[i].imshow(temp, cmap=plt.cm.jet)  # cmap='gray'
                    ax[i].axis('off')
            # LOGGER.info(f'Saving {f}... ({n}/{channels})')
            print(f'Saving {f}... ({n}/{channels})')
            plt.savefig(f, dpi=300, bbox_inches='tight')
            plt.close()
            np.save(str(f.with_suffix('.npy')), x[0].cpu().numpy())  # npy save